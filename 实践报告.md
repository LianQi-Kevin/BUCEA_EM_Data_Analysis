## 实践报告

### 1. Requirements

```shell
# python >= 3.9
pip install -r requirements.txt
```

#### 1.1 aiohttp、aiofiles 和 requests

1. **aiohttp**: `aiohttp`
   是一个用于异步网络请求的库。它支持异步IO（输入输出）操作，使得在处理网络请求时不会阻塞整个程序的运行。这意味着当一个网络请求被发送出去时，程序可以继续执行其他任务，直到网络请求完成。`aiohttp`
   在处理高并发、实时数据处理和Websocket等场景下非常有用。
2. **aiofiles**: `aiofiles` 是专门用于异步文件操作的库。就像`aiohttp`处理网络请求一样，`aiofiles`
   允许程序在读写文件时不阻塞，从而提高整体性能。这在处理大型文件或者在需要高效读写操作的场景中非常有用。
3. **requests**: `requests` 是一个用于发送HTTP请求的库，它是同步的，非常简单易用。通过`requests`
   ，你可以轻松发送GET、POST、PUT、DELETE等HTTP请求，并处理返回的响应。它适合于那些不需要并发处理或异步操作的场景，比如简单的数据抓取、API调用等。

在该库中，`aiohttp`和`aiofiles`被用于`async_main.py`以执行异步网络请求，`requests`被用于`multi-thread_main.py`以执行多线程请求。

#### 1.2 Pydantic

`Pydantic `是一个用于数据验证和管理的 Python 库。它主要通过基于 Python
类型注解的方式来定义数据模型，这使得代码既简洁又具有表达力。`Pydantic `
确保数据符合定义的模型，提供了数据类型的自动转换功能，并能在数据不符合预期时抛出详细的错误信息。这样，它可以轻松地用于配置文件的管理、API的数据处理，以及在系统各个部分之间传递和验证数据。

在该库中，`Pydantic `被用于`tools/pydantic_types.py`
以执行数据爬取前请求体构建、爬取结果校验和自动JSON解析，并在响应载荷不全情况下抛出`ValidationError`，以便`try/except`
捕获相关错误并自动重新构建请求。

#### 1.3 pandas

`Pandas`
是一个开源的Python库，广泛用于数据分析和数据处理。它提供了高性能、易于使用的数据结构和数据分析工具，特别是对于表格数据。`Pandas`
的核心数据结构是`DataFrame`，它是一个二维标签数据结构，可存储不同类型的数据。`Pandas`
支持各种数据操作，如过滤、分组、合并、重塑等。它还提供了强大的时间序列功能，以及读取和写入多种文件格式的能力，如CSV、Excel、SQL数据库等。`Pandas`
适用于处理和分析各种实际数据，是Python数据科学领域的重要工具之一。

在该库中，`Pandas `被用于`EM_drawer.py`以执行本地CSV数据读取、条件筛选、多层索引构建、时间序列重映射、数据切片及`pivot_table`
构建，以便配合`matplotlib`对结果进行绘制出图。

#### 1.4 Matplotlib

`Matplotlib `是一个用于创建高质量图表的 Python
库。它可以生成各种静态、动态和交互式的图表，如折线图、散点图、条形图和其他专业图表。`Matplotlib `
设计灵活，易于使用，支持各种输出格式，并且可以很好地与其他科学计算工具集成，如 Numpy 和
Pandas。它通常用于数据可视化和图形表示，是数据分析和科学研究中常用的工具之一。

在该库中，`Matplotlib `被用于`EM_drawer.py`
以执行数据处理后的结果绘制，透过参数配置实现了主题选择、线条样式定义等，配合`Pandas`对结果进行绘制出图。

### 2. 文件结构及内容

该代码库由以下结构组成

```
BUCEA_EM_Data_Analysis
│ async_main.py
│ EM_drawer.py
│ multi-thread_main.py
│ xinfadi_price_detail.csv
└─tools
   │  logging_utils.py 
   └─ pydantic_types.py
```

#### 2.1 tools/pydantic_types.py

这个Python文件 `tools/pydantic_types.py` 使用了 Pydantic 库来定义数据模型。Pydantic 是一个流行的 Python
库，用于数据验证和设置管理，主要基于 Python 类型提示。文件中定义了三个基于 Pydantic
的数据模型，用于处理某种类型的数据请求和响应。下面是对文件内容的详细解读和技术特点说明，以及一个调用示例代码。

##### 2.1.1 文件内容

1. **导入依赖**：
    - `datetime`：用于处理日期和时间。
    - `List, Optional, Any`：来自 `typing` 模块，用于类型注解。
    - `BaseModel, Field`：来自 `pydantic`，用于定义数据模型。

2. **XinFaDiPriceDetailRequest 类**：
    - 这是一个请求模型，定义了请求的结构。
    - 包含多个字段，如 `limit`, `current`, `pubDateStartTime` 等。
    - 字段类型包括 `int` 和 `str`，使用了默认值和 `None`（可选类型）。

3. **XinFaDiPriceDetailResponseDataObject 类**：
    - 定义了响应数据对象的结构。
    - 包括多个字段，如 `object_id`, `prodName`, `lowPrice`, `avgPrice` 等。
    - 使用了 `Field` 来指定别名，例如 `object_id` 字段在序列化时使用 `id` 作为键。
    - 包含了可选类型和日期时间类型。

4. **XinFaDiPriceDetailResponse 类**：
    - 定义了完整的响应结构。
    - 包含 `current`, `limit`, `count` 和 `list` 字段。
    - `list` 字段是一个 `XinFaDiPriceDetailResponseDataObject` 对象的列表，用于存储多个数据项。

##### 2.1.2 技术特点

- **类型安全**：利用 Python 类型注解来确保数据安全。
- **数据验证**：Pydantic 在数据加载到模型时自动进行验证。
- **简洁的定义**：使用类和默认值快速定义数据结构。
- **灵活的数据处理**：支持别名、可选字段等特性，便于处理复杂的数据结构。

##### 2.1.3 调用示例

```python
from tools.pydantic_types import XinFaDiPriceDetailRequest, XinFaDiPriceDetailResponse

# 创建请求实例
request = XinFaDiPriceDetailRequest(current=1, pubDateStartTime="2023-01-01")
# 假设这里调用了priceDetail API并获得了响应数据
response_data = {
    "current": 1, "limit": 20, "count": 100,
    "list": [
        {"id": 123, "prodName": "苹果", "lowPrice": 5.0, "highPrice": 10.0,
         "avgPrice": 7.5, "pubDate": "2023-01-01 12:00:00"}
        # ... 更多数据项
    ]
}
# 将响应数据加载到模型
response = XinFaDiPriceDetailResponse(**response_data)
```

#### 2.2 async_main.py

这个 `async_main.py` 文件是一个使用了异步编程和网络请求的 Python 脚本。下面是它的主要技术特点和一些调用示例代码的解释。

##### 2.2.1 技术特点

1. **异步编程（asyncio）**: 该脚本使用 `asyncio` 库来处理并发任务。这种方法允许程序在等待IO操作（如网络请求）完成时执行其他任务，从而提高效率。

2. **aiohttp库**: 用于发起异步HTTP请求。这使得脚本可以在等待服务器响应时继续执行其他任务。

3. **CSV文件操作**: 使用 `aiofiles` 库异步写入CSV文件，这可以避免阻塞主线程。

4. **日志记录**: 使用 `logging` 库记录程序的运行情况，帮助调试和监控脚本的执行。

5. **异常处理和重试机制**: 在网络请求中加入了异常处理和重试机制，以应对网络不稳定或其他错误情况。

6. **Pydantic**: 使用 `pydantic` 库进行数据验证和模型转换，保证数据的准确性和易于处理。

##### 2.2.2 调用示例

这个脚本主要完成从 "新发地" 网站获取价格数据的功能。以下是如何使用这个脚本的一个简单示例：

```python
import asyncio
from tools.pydantic_types import XinFaDiPriceDetailRequest

# 你需要先定义 XinFaDiPriceDetailRequest 的结构
request_data = XinFaDiPriceDetailRequest(limit=20, current=1)

# 调用主函数来开始任务
asyncio.run(main(single_limit=20, export_path="xinfadi_price_detail.csv"))
```

#### 2.3 EM_drawer.py

##### 2.3.1 技术特点

这个Python文件 `EM_drawer.py` 是一个数据可视化工具，主要用于处理和绘制基于时间序列的价格数据。它具有以下技术特点：

1. **数据处理和分析**: 使用Pandas库来加载、预处理和筛选数据。它能处理CSV文件，支持按照日期范围、地点、产品类别等多种条件进行筛选。

2. **异常值处理**: 通过IQR（四分位数范围）方法对数据中的异常值进行过滤。

   IQR（Interquartile Range，四分位数范围）法用于筛选异常值，具有以下优点：

    1. **鲁棒性**：IQR法对异常值（特别是极端值）不敏感，因为它基于数据的四分位数，而不是平均值和标准差。这使得它在存在异常值的情况下仍然有效。

    2. **简单直观**：IQR法的概念简单，易于理解和实施。只需计算第一四分位数（Q1）和第三四分位数（Q3），然后确定异常值的范围。

    3. **适用性广**：适用于不同类型的数据分布，包括非正态分布的数据集。

    4. **灵活性**：可以通过调整IQR的倍数来调整异常值识别的严格程度。常用的倍数是1.5倍IQR（用于温和的异常值检测）和3倍IQR（用于更极端的异常值检测）。

    5. **数据清洗**：在数据分析和机器学习的预处理阶段，IQR法是一种有效的方法来清洗数据，提高模型的准确性和可靠性。

   综上所述，IQR法是一个简单而强大的工具，用于在各种数据集中有效地识别和处理异常值。

3. **数据可视化**: 使用Matplotlib库绘制时间序列图，支持自定义图表大小、标签、标题和样式。图表主题可以是白色或黑色，支持保存为图像文件。

4. **灵活的配置**: 提供了多个配置选项，如分组频率、筛选条件和绘图参数。

5. **中文支持**: 设置了matplotlib参数来支持中文显示和解决负号显示问题。

##### 2.3.2 调用示例

```python
from EM_drawer import EMDrawer

# 创建EMDrawer实例
em_drawer = EMDrawer(filepath="./xinfadi_price_detail.csv")

# 筛选数据：2023年1月1日到2023年12月31日
em_drawer.filter_data(start_date="2023-01-01", end_date="2023-12-31")

# 预处理数据，按周分组
em_drawer.preprocess(grouper_freq='W')

# 绘制并保存图表
em_drawer.plot(
    prod_names=["大白菜", "小白菜"],
    plot_values=['avgPrice'],
    save_path="./save.png",
    outlier_threshold=1.5,
    theme="white"
)
```

### 3. 技术优点

#### 3.1 异步数据爬取与写入技术

- **提高效率**：asyncio提供了一个事件循环，能够在单个线程内执行多个任务。结合aiohttp异步发起网络请求和aiofiles异步进行文件操作，可以显著提高数据爬取和写入的效率。
- **更好的性能**：异步操作可以减少等待时间，特别是在网络请求和磁盘I/O操作时，可以避免因等待响应或写入而浪费时间，从而提升整体性能。
- **更低的资源消耗**：相比于多线程或多进程，异步编程模型可以在单个线程内处理多个任务，降低了资源消耗，特别是在协调大量并发操作时更为明显。

#### 3.2 Pydantic在数据校验中的应用

- **类型安全和自动校验**：Pydantic可以确保数据结构符合预定义的模型，自动进行类型校验，减少数据处理过程中的错误。
- **代码可读性和维护性提升**：通过定义清晰的数据模型，Pydantic提升了代码的可读性和维护性，使得代码更易于理解和修改。
- **开发效率提升**：Pydantic的模型定义简洁，支持自动的序列化和反序列化，可以加快开发流程，减少处理请求和响应数据时的重复工作。

#### 3.3 使用Pandas与Matplotlib进行数据分析和可视化

- **数据处理能力强**：pandas提供了强大的数据处理功能，能够方便地对CSV文件进行读取、清洗、转换等操作。
- **丰富的数据分析工具**：pandas结合matplotlib可以提供丰富的数据分析和可视化工具，帮助用户从数据中发现趋势和模式。
- **直观的数据展示**：matplotlib可以创建各种图表，如柱状图、折线图、散点图等，帮助用户以直观的方式展示和解释数据，特别适合于展示爬虫结果的数据分析和报告。